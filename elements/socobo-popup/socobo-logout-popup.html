<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/font-roboto/roboto.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">


<polymer-element name="socobo-logout-popup"
                 attributes="authToken">
  <template>
    <style>
      /*Default Element Settings*/
      :host {
        font-family: RobotoDraft, 'Helvetica Neue', Helvetica, Arial;
      }

      paper-dialog {
        width: 23%;
        min-width: 200px;
        height: 200px;
        margin: 0px;
        padding: 0px;
      }

      paper-dialog paper-button {
        font-weight: bold;
      }

      paper-button[autofocus] {
        color: #4285f4;
      }
    </style>

    <paper-dialog id="socoboLogoutPopup"
                  heading="Logout"
                  layered="false"
                  transition="core-transition-top"
                  backdrop
                  autoCloseDisabled>
      <p>Are you sure you want to log out?</p>

      <paper-button on-click="{{closePopup}}"
                    affirmative
                    autofocus>Cancel</paper-button>

      <paper-button on-click="{{logoutUser}}"
                    affirmative>Ok</paper-button>

      <core-ajax
        id="socoboLogoutForm"
        url="/logout"
        method="POST"
        headers='{"X-AUTH-TOKEN":"{{authtoken}}"}'
        handleAs="json"
        contentType="application/json"
        on-core-response="{{handleLogutOnResponse}}"
        on-core-error="{{handleLogutOnError}}">
      </core-ajax>
    </paper-dialog>

  </template>
  <script>
    Polymer('socobo-logout-popup', {
      /**
       * @variable: authToken
       * @datatype: String
       * @defaultValue: undefined
       * @description:
       * - identify the user
       */
      authToken: undefined,

      /**
       * @function: showPopup
       * @params:
       * @description:
       * - show popup
       */
      showPopup: function() {
         this.$.socoboLogoutPopup.toggle();
      },

      /**
       * @function: closePopup
       * @params:
       * @description:
       * - close popup
       */
      closePopup: function() {
        this.$.socoboLogoutPopup.toggle();
      },

      /**
       * @function: logoutUser
       * @params:
       * @description:
       * - fire form content to backend
       * - shows a toast message to inform the user
       */
      logoutUser: function() {
        this.$.socoboLogoutForm.go();
        this.$.toast.text = "Logout submitted!";
        this.$.toast.show();
      },

      /**
       * @function: handleLogutOnResponse
       * @params: e - event
       * @description:
       * - handle response from backend
       * - shows a toast message to inform the user
       * - firing custom event to socobo-app with cleared authToken
       */
      handleLogutOnResponse: function(e) {
        this.$.toast.text = "Response entered!";
        this.$.toast.show();

        var statusCode = e.detail.xhr.status;
        if (statusCode === 200) {
          this.fire('logout-response-ok', {authToken: undefined});
        } else {
          this.fire('logout-response-failed', {statusCode: statusCode});
        }
      },

      /**
       * @function: handleLogutOnError
       * @params: e - event
       * @description:
       * - handle error from backend
       * - firing custom event to socobo-app
       */
      handleLogutOnError: function(e) {
        var statusCode = e.detail.xhr.status;
        console.log('handleLogoutOnError: ' + statusCode);
        this.fire('logout-response-failed', {statusCode: statusCode});
      }
    });
  </script>
</polymer-element>